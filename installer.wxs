<?xml version='1.0' encoding='windows-1252'?>
<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi' xmlns:difx='http://schemas.microsoft.com/wix/DifxAppExtension'>
  <?if $(env._BUILDARCH) = x86 ?>
    <?define ARCHDIR = i386 ?>
    <?define PFILESDIR = ProgramFilesFolder ?>
  <?elseif $(env._BUILDARCH) = AMD64 ?>
    <?define ARCHDIR = amd64 ?>
    <?define PFILESDIR = ProgramFiles64Folder ?>
  <?endif ?>

  <Module  Id='guiAgentWindows'
    Language='1033' Codepage='1252' Version='$(env.VERSION)'>

    <Package Id='{99FAD33F-658E-4F04-966C-52061AC0BC45}' Keywords='Installer' Description="Qubes Gui Agent for Windows"
      Comments='no comment' Manufacturer='Invisible Things Lab' InstallScope='perMachine'
      InstallerVersion='200' Languages='1033' SummaryCodepage='1252'
      InstallPrivileges="elevated" />

    <Configuration Name="ProductFolder" Format="Key" Type="Identifier" DefaultValue="QubesProgramFilesDir"
      Description="Installation directory" DisplayName="Installation directory"/>
    <Substitution Table="Directory" Column="Directory_Parent"
      Row="BinDir" Value="[=ProductFolder]"/>
    <Substitution Table="Directory" Column="Directory_Parent"
      Row="DriversDir" Value="[=ProductFolder]"/>

    <Property Id="MSIRESTARTMANAGERCONTROL" Value="Disable" SuppressModularization="yes"/>

    <Directory Id='TARGETDIR' Name='SourceDir'>
      <Directory Id='$(var.PFILESDIR)'>
        <Directory Id='ITLProgramFilesDir' Name='Invisible Things Lab'>
          <Directory Id='QubesProgramFilesDir' Name='Qubes'>
            <Directory Id='BinDir' Name='bin'>
              <Component Id='GuiAgent' Guid='{69131C28-618B-4662-9AFC-70767E50F05D}'>
                <File Id='wga.exe' DiskId='1' Source='gui-agent\bin\$(var.ARCHDIR)\wga.exe' KeyPath="yes"/>
                <!--
                <ServiceInstall
                Id="ServiceInstaller"
                Type="ownProcess"
                Vital="yes"
                Name="GUIAgent"
                DisplayName="Qubes GUI Agent"
                Description="Qubes GUI agent"
                Start="auto"
                Account="LocalSystem"
                ErrorControl="ignore"
                Interactive="no"
                />
                <ServiceControl Id="StartService" Start="install" Stop="both" Remove="uninstall" Name="GUIAgent" Wait="yes" />
                -->
                <RegistryKey Root='HKLM' Key='Software\Microsoft\Windows\CurrentVersion\Run'>
                    <RegistryValue Type='string' Name='Qubes GUI Agent' Value='"[BinDir]wga.exe"'/>
                </RegistryKey>
              </Component>
            </Directory>
            <Directory Id='DriversDir' Name='drivers'>
              <Component Id='qvideo' Guid='{EC90C049-0025-4815-9106-6ABC438470A4}'>
                <File Id='qvideo.cat' DiskId='1' Source='qvideo\bin\$(var.ARCHDIR)\qvideo.cat'/>
                <File Id='qvgdi.dll' DiskId='1' Source='qvideo\bin\$(var.ARCHDIR)\qvgdi.dll'/>
                <File Id='qvmini.sys' DiskId='1' Source='qvideo\bin\$(var.ARCHDIR)\qvmini.sys'/>
                <File Id='qvideo.inf' DiskId='1' Source='qvideo\bin\$(var.ARCHDIR)\qvideo.inf'/>
				<!-- moved to custom table below -->
				<!-- <difx:Driver Sequence='10' Legacy='yes' PlugAndPlayPrompt='no' ForceInstall='yes'/>-->
              </Component>
            </Directory>
          </Directory>
        </Directory>
      </Directory>
    </Directory>
	<!-- cannot use difx:Drive element because it requires difx lib linked with
	this module, which causes conflict with vmm-xen-windows-drivers (which also
	uses DIFx extension). This basically means that only one merge module
	can use DIFx extention (see http://sourceforge.net/p/wix/feature-requests/432/).
	But this also means that final MSI will already have all necesary steps to
	install the drivers. So just append our driver to the MsiDriverPackage
	table, to be also installed. -->
	<!-- Table schema here: http://msdn.microsoft.com/en-us/library/windows/hardware/ff549362%28v=vs.85%29.aspx -->
	<CustomTable Id="MsiDriverPackages">
	  <Column Id="Component" Modularize="Column" Nullable="no" Type="string" Width="255"
	      Description="An identifier that represents a driver package" PrimaryKey="yes"/>
	  <Column Id="Flags" Nullable="no" Type="int" Width="4"
	      Description="DIFxApp configuration flags"/>
	  <Column Id="Sequence" Nullable="yes" Type="int" Width="4"
	      Description="Installation sequence number"/>
	  <Row>
		<Data Column="Component">qvideo</Data>
		<Data Column="Flags">15</Data>
		<Data Column="Sequence">1</Data>
	  </Row>
	</CustomTable>

	<Binary Id="CreateDeviceHelper" SourceFile="install-helper\bin\$(var.ARCHDIR)\create-device.exe"/>
	<Binary Id="DisableDevHelper" SourceFile="install-helper\bin\$(var.ARCHDIR)\disable-device.exe"/>
	<Binary Id="SystemSettings" SourceFile="install-helper\bin\$(var.ARCHDIR)\system-settings.exe"/>

	<CustomAction Id="RegisterVideoDevice" Return="check" Impersonate="no" Execute="deferred"
		BinaryKey="CreateDeviceHelper"
		ExeCommand='"[DriversDir]qvideo.inf" ITL_QubesVideo'/>

	<!-- Disable all PCI Display devices. Our device is ROOT device -->
	<CustomAction Id="DisableSVGA" Return="ignore" Impersonate="no" Execute="deferred"
		BinaryKey="DisableDevHelper"
		ExeCommand='-d Display'/>

	<CustomAction Id="RollbackDisableSVGA" Return="ignore" Impersonate="no" Execute="rollback"
		BinaryKey="DisableDevHelper"
		ExeCommand='-e Display'/>

	<CustomAction Id="EnableSVGA" Return="ignore" Impersonate="no" Execute="deferred"
		BinaryKey="DisableDevHelper"
		ExeCommand='-e Display'/>

	<CustomAction Id="ApplySysSettings" Return="check" Impersonate="no" Execute="deferred"
		BinaryKey="SystemSettings"
		ExeCommand='--apply'/>

	<CustomAction Id="RollbackSysSettings" Return="ignore" Impersonate="no" Execute="rollback"
		BinaryKey="SystemSettings"
		ExeCommand='--rollback'/>

	<CustomAction Id="UndoSysSettings" Return="ignore" Impersonate="no" Execute="deferred"
		BinaryKey="SystemSettings"
		ExeCommand='--rollback'/>

	<InstallExecuteSequence>
	  <Custom Action="RegisterVideoDevice" After="InstallFiles">
        NOT Installed
      </Custom>
	  <Custom Action="RollbackDisableSVGA" Before="DisableSVGA"/>
	  <Custom Action="DisableSVGA" Before="InstallFinalize">
        NOT Installed
      </Custom>
      <Custom Action="RollbackSysSettings" Before="ApplySysSettings"/>
      <Custom Action="ApplySysSettings" After="InstallFiles"/>
	  <!-- enable it back on uninstall -->
	  <Custom Action="EnableSVGA" Before="InstallFinalize">
        REMOVE="ALL"
      </Custom>
      <Custom Action="UndoSysSettings" Before="InstallFinalize">
        REMOVE="ALL"
      </Custom>
	</InstallExecuteSequence>


	</Module>
</Wix>
